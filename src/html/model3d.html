<!doctype html>
<html lang="ru">
@include('modules/link.html',{ 'title': 'Main' })

<body>
	@include('modules/header.html',{'theme':'black'})
	<div id="viewer" style="width:100%; height:100vh;">
		<canvas id="scene"></canvas>
	</div>
	<script src="https://unpkg.com/three@0.140.0/build/three.min.js"></script>
	<script src="https://unpkg.com/three@0.140.0/examples/js/loaders/GLTFLoader.js"></script>
	<script src="https://unpkg.com/three@0.140.0/examples/js/controls/OrbitControls.js"></script>
	<script src="https://unpkg.com/three@0.140.0/examples/js/loaders/RGBELoader.js"></script>

	<style>
		#viewer {
			width: 100%;
			height: 100vh;
		}
	</style>



	<script>
		const container = document.getElementById('viewer');
		const canvas = document.getElementById('scene');

		// Сцена
		const scene = new THREE.Scene();

		// Камера (фиксированный FOV!)
		const camera = new THREE.PerspectiveCamera(10, container.clientWidth / container.clientHeight, 0.1, 1000);
		camera.position.set(0, 0, 2);

		// Рендерер
		const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
		renderer.setSize(container.clientWidth, container.clientHeight);
		renderer.setPixelRatio(window.devicePixelRatio);
		renderer.outputEncoding = THREE.sRGBEncoding;

		// Контролы
		const controls = new THREE.OrbitControls(camera, renderer.domElement);
		controls.enableZoom = false;
		controls.enablePan = false;
		controls.enableDamping = true;

		// HDRI
		const textureLoader = new THREE.TextureLoader();
		textureLoader.load('/static/model/bg.png', function (pngTexture) {
			pngTexture.mapping = THREE.EquirectangularReflectionMapping;
			const pmremGenerator = new THREE.PMREMGenerator(renderer);
			const envMap = pmremGenerator.fromEquirectangular(pngTexture).texture;
			scene.environment = envMap;
			pmremGenerator.dispose();
		});

		// Свет
		scene.add(new THREE.AmbientLight(0xffffff, 1));

		const dir1 = new THREE.DirectionalLight(0xffffff, 1);
		dir1.position.set(20, 20, 50);
		scene.add(dir1);

		const dir2 = new THREE.DirectionalLight(0xffffff, 0.6);
		dir2.position.set(-50, -50, 100);
		scene.add(dir2);


		//------------------------------------------------------------
		// Функция адаптивной подстройки камеры
		//------------------------------------------------------------
		function fitCameraToObject(camera, object, offset = 1.5) {
			const box = new THREE.Box3().setFromObject(object);

			const size = box.getSize(new THREE.Vector3());
			const center = box.getCenter(new THREE.Vector3());

			const maxDim = Math.max(size.x, size.y, size.z);

			// вычисляем расстояние, при котором объект входит в кадр
			const fov = camera.fov * (Math.PI / 180);
			let cameraZ = (maxDim / 2) / Math.tan(fov / 2);

			cameraZ *= offset; // запас

			camera.position.set(center.x, center.y, cameraZ + center.z);
			camera.lookAt(center);

			camera.updateProjectionMatrix();
		}


		//------------------------------------------------------------
		// Загрузка модели
		//------------------------------------------------------------
		let watch = null;

		const loader = new THREE.GLTFLoader();
		loader.load('/static/model/model.glb', function (gltf) {
			watch = gltf.scene;
			scene.add(watch);

			// автоцентрирование + авто-расстояние камеры
			fitCameraToObject(camera, watch);
		});


		//------------------------------------------------------------
		// Анимация
		//------------------------------------------------------------
		function animate() {
			requestAnimationFrame(animate);
			controls.update();
			renderer.render(scene, camera);
		}
		animate();


		//------------------------------------------------------------
		// Адаптивный ресайз
		//------------------------------------------------------------
		function onWindowResize() {
			const width = container.clientWidth;
			const height = container.clientHeight;

			camera.aspect = width / height;
			camera.updateProjectionMatrix();
			renderer.setSize(width, height);

			// повторно подстраиваем дистанцию
			if (watch) fitCameraToObject(camera, watch);
		}

		window.addEventListener('resize', onWindowResize);
	</script>
</body>

</html>